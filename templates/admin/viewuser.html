{% extends 'admin/base.html' %}
{% load static %}
{% block content %}

<!-- Styles -->
<style>
    table {
        border-collapse: collapse;
        width: 100%;
    }

    th, td {
        text-align: center;
        padding: 6px;
    }

    tr:nth-child(even) {
        background-color: #D6EEEE;
    }

    img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 6px;
    }

    .pagination {
        justify-content: center;
        margin-top: 15px;
    }
</style>

<!-- View Workers -->
<section class="w3l-team" id="team">
    <div class="team-block py-5">
        <div class="container py-lg-5">
            <div class="row justify-content-center text-center">
                <div class="col-md-8">
                    <div class="section-heading mb-sm-5 mb-4">
                        <h3 class="title-style mb-2" style="margin-top: -7%;">View Users</h3><br>
                    </div>
                </div>
            </div>

            {% if abc %}
            <!-- Search & Export -->
            <div class="d-flex justify-content-between mb-3">
                <input type="text" id="searchInput" placeholder="Search users..."
                    class="form-control w-25">
                <div>
                    <button class="btn btn-success btn-sm mx-1" onclick="exportTableToExcel('usersTable','Users')">Export Excel</button>
                    <button class="btn btn-danger btn-sm mx-1" onclick="exportTableToPDF()">Export PDF</button>
                </div>
            </div>

            <div class="table-container">
                <table id="workerTable" class="table table-bordered table table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Gender</th>
                            <th>Address</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for i in abc %}
                        <tr>
                            <td>{{ i.name }}</td>
                            <td>{{ i.email }}</td>
                            <td>{{ i.phone }}</td>
                            <td>{{ i.gender }}</td>
                            <td>{{ i.address }}</td>
                            <td>
                                <div class="d-flex justify-content-center">
                                    <a href="/edituser?id={{ i.usrid_id }}" class="btn btn-warning btn-sm mx-1">Edit</a>
                                    <a href="/rejecteduser?ab={{ i.usrid_id }}" class="btn btn-danger btn-sm mx-1">Delete</a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <nav>
                <ul class="pagination" id="pagination"></ul>
            </nav>
            {% else %}
                <p class="text-center text-danger">No users found.</p>
            {% endif %}
        </div>
    </div>
</section>

<!-- JS for Search + Pagination + Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    const rowsPerPage = 5;
    let currentPage = 1;

    function paginateTable() {
        const table = document.getElementById("userTable");
        const rows = table.querySelectorAll("tbody tr");
        const totalRows = rows.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage);

        rows.forEach((row, index) => {
            row.style.display = (index >= (currentPage - 1) * rowsPerPage && index < currentPage * rowsPerPage) ? "" : "none";
        });

        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";
        for (let i = 1; i <= totalPages; i++) {
            pagination.innerHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                                        <a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
                                     </li>`;
        }
    }

    function goToPage(page) {
        currentPage = page;
        paginateTable();
    }

    document.getElementById("searchInput").addEventListener("keyup", function () {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll("#workerTable tbody tr");
        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(filter) ? "" : "none";
        });
    });

    // Export to Excel
    function exportTableToExcel(tableID, filename = '') {
        const table = document.getElementById(tableID);
        const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
        return XLSX.writeFile(wb, filename ? filename + '.xlsx' : 'users.xlsx');
    }

    // Export to PDF
    function exportTableToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.autoTable({ html: '#userTable' });
        doc.save('users.pdf');
    }

    window.onload = paginateTable;
</script>

{% endblock %}
